@model Connectify.Models.Group
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewBag.Title = Model.GroupName;
}

<h2 class="text-center">@Model.GroupName</h2>
<p class="text-muted text-center">@Model.Description</p>

<hr />

@if (TempData.ContainsKey("message"))
{
    <div class="alert @(TempData["messageType"] ?? "alert-info")">
        @TempData["message"]
    </div>
}

<!--actiuni grup-->
<div class="d-flex justify-content-between my-3">
    @if (User.IsInRole("Admin") || Model.UserId == ViewBag.CurrentUserId)
    {
        <a asp-action="Edit" asp-controller="Groups" asp-route-id="@Model.Id" class="btn btn-primary">Edit Group</a>
        <form asp-action="Delete" asp-controller="Groups" asp-route-id="@Model.Id" method="post" onsubmit="return confirm('Are you sure you want to delete this group?');">
            <button type="submit" class="btn btn-danger">Delete Group</button>
        </form>
    }
</div>

<!--mesajul pentru moderator-->
@if (Model.UserId == ViewBag.CurrentUserId && Model.UserGroups.Count(ug => ug.IsAccepted) == 1)
{
    <p class="text-danger">You are the only member in this group. You can only delete it.</p>
    <form asp-action="Delete" asp-controller="Groups" method="post" class="mt-3">
        <input type="hidden" name="id" value="@Model.Id" />
        <button type="submit" class="btn btn-danger">Delete Group</button>
    </form>
}


<hr />

<!--sectiune pt mesaje-->
<h3>Group Messages</h3>
<div class="card mb-4">
    <div class="card-body">
        @if (Model != null && Model.Messages != null && Model.Messages.Any())
        {
            @foreach (var message in Model.Messages)
            {
                <div class="card mb-3">
                    <div class="card-body">
                        <p><strong>@message.User?.UserName:</strong> @message.TextMessage</p>
                        <p class="text-muted"><small>Sent at: @message.SentAt.ToString("yyyy-MM-dd HH:mm")</small></p>

                        @if (User.IsInRole("Admin") || message.UserId == ViewBag.CurrentUserId)
                        {
                            <div class="d-flex justify-content-end">
                                <a asp-action="Edit" asp-controller="Messages" asp-route-id="@message.Id" class="btn btn-sm btn-outline-primary">Edit</a>
                                <form asp-action="Delete" asp-controller="Messages" asp-route-id="@message.Id" method="post">
                                    <button type="submit" class="btn btn-sm btn-outline-danger ms-2">Delete</button>
                                </form>
                            </div>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <p>No messages in this group yet.</p>
        }
    </div>
</div>

<!--adaugare mesaj-->
<h4>Add a New Message</h4>
<form asp-action="Show" asp-controller="Groups" method="post">
    <input type="hidden" name="id" value="@Model.Id" />
    <div class="form-group">
        <label for="TextMessage">Message:</label>
        <textarea name="TextMessage" class="form-control" placeholder="Write your message here..."></textarea>
    </div>
    <button type="submit" class="btn btn-success mt-2">Send Message</button>
</form>

<hr />

<!--parasire grup-->
@* @if (ViewBag.UserGroups != null && ((List<int>)ViewBag.UserGroups).Contains(Model.Id)) *@
@* { *@
@*     <form asp-action="LeaveGroup" asp-controller="Groups" method="post" class="mt-3"> *@
@*         <input type="hidden" name="id" value="@Model.Id" /> *@
@*         <button type="submit" class="btn btn-warning">Leave Group</button> *@
@*     </form> *@
@* } *@

@if (ViewBag.UserGroups != null && ((List<int>)ViewBag.UserGroups).Contains(Model.Id))
{
    <form asp-action="LeaveGroup" asp-controller="Groups" method="post" class="mt-3">
        <input type="hidden" name="id" value="@Model.Id" />
        <button type="submit" class="btn btn-warning">Leave Group</button>
    </form>
}

<hr />

<!--lista membrilor din grup-->
<h3>Group Members</h3>
<ul class="list-group">
    @foreach (var member in Model.UserGroups.Where(ug => ug.IsAccepted))
    {
        <li class="list-group-item d-flex justify-content-between align-items-center">
            @member.User.UserName
            @if (User.IsInRole("Admin") || Model.UserId == ViewBag.CurrentUserId)
            {
                <form asp-action="RemoveMember" asp-controller="Groups" method="post">
                    <input type="hidden" name="groupId" value="@Model.Id" />
                    <input type="hidden" name="userId" value="@member.UserId" />
                    <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                </form>
            }
        </li>
    }
</ul>



<!--cereri in asteptare-->
<h4>Pending Requests</h4>
@if (Model.UserId == ViewBag.CurrentUserId || User.IsInRole("Admin"))
{
    <ul class="list-group">
        @foreach (var request in Model.UserGroups.Where(ug => !ug.IsAccepted))
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                @request.User.UserName
                <div class="d-flex">
                    <!-- Approve button -->
                    <form asp-action="ApproveUser" asp-controller="Groups" method="post">
                        <input type="hidden" name="groupId" value="@Model.Id" />
                        <input type="hidden" name="userId" value="@request.UserId" />
                        <button type="submit" class="btn btn-sm btn-success me-2">Approve</button>
                    </form>

                    <!-- Decline button -->
                    <form asp-action="DeclineUser" asp-controller="Groups" method="post">
                        <input type="hidden" name="groupId" value="@Model.Id" />
                        <input type="hidden" name="userId" value="@request.UserId" />
                        <button type="submit" class="btn btn-sm btn-danger">Decline</button>
                    </form>
                </div>
            </li>
        }
    </ul>
}

