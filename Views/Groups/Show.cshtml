@model Connectify.Models.Group
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewBag.Title = Model.GroupName ?? "Group Details";
}

<div class="container my-5">
    <!-- Titlu grup -->
    <div class="row mb-4">
        <div class="col text-center">
            <h1 class="display-4">@Model.GroupName</h1>
            <p class="text-muted">@Model.Description</p>
        </div>
    </div>

    <!-- Mesaje flash -->
    @if (TempData.ContainsKey("message"))
    {
        <div class="row mb-4">
            <div class="col">
                <div class="alert @(TempData["messageType"] != null ? TempData["messageType"] : "alert-info")">
                    @TempData["message"]
                </div>
            </div>
        </div>
    }

    <!-- Mesaje din grup -->
    <div class="row mb-4">
        <div class="col">
            <h3>Group Messages</h3>
            <div class="card">
                <div class="card-body">
                    @if (Model.Messages != null && Model.Messages.Any())
                    {
                        @foreach (var message in Model.Messages)
                        {
                            <div class="card mb-3">
                                <div class="card-body">
                                    @if (message.User != null)
                                    {
                                        <p><strong>@message.User.UserName:</strong> @message.TextMessage</p>
                                        <p class="text-muted"><small>Sent at: @message.SentAt.ToString("yyyy-MM-dd HH:mm")</small></p>

                                        @if (User.IsInRole("Admin") || message.UserId == ViewBag.CurrentUserId)
                                        {
                                            <div class="d-flex justify-content-end">
                                                <a asp-action="Edit" asp-controller="Messages" asp-route-id="@message.Id" class="btn btn-sm btn-outline-primary">Edit</a>
                                                <form asp-action="Delete" asp-controller="Messages" asp-route-id="@message.Id" method="post" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger ms-2">Delete</button>
                                                </form>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-danger">Message details are missing.</p>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted">No messages in this group yet.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Adăugare mesaj -->
    <div class="row mb-4">
        <div class="col">
            <h4>Add a New Message</h4>
            <form asp-action="Show" asp-controller="Groups" method="post">
                <input type="hidden" name="id" value="@Model?.Id ?? 0" />
                <div class="form-group mb-3">
                    <textarea name="TextMessage" class="form-control" placeholder="Write your message here..." required></textarea>
                </div>
                <button type="submit" class="btn btn-success">Send Message</button>
            </form>
        </div>
    </div>

    <!-- Membrii grupului -->
    @if (Model.UserGroups != null)
    {
        <div class="row">
            <div class="col-md-6">
                <h3>Group Members</h3>
                <ul class="list-group">
                    @foreach (var member in Model.UserGroups.Where(ug => ug.IsAccepted))
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            @member.User.UserName
                            @if (User.IsInRole("Admin") || Model.UserId == ViewBag.CurrentUserId)
                            {
                                <form asp-action="RemoveMember" asp-controller="Groups" method="post" class="d-inline">
                                    <input type="hidden" name="groupId" value="@Model.Id" />
                                    <input type="hidden" name="userId" value="@member.UserId" />
                                    <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                                </form>
                            }
                        </li>
                    }
                </ul>
            </div>

            <div class="col-md-6">
                <h3>Pending Requests</h3>
                <ul class="list-group">
                    @foreach (var request in Model.UserGroups.Where(ug => !ug.IsAccepted))
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            @request.User.UserName
                            <div class="d-flex">
                                <form asp-action="ApproveUser" asp-controller="Groups" method="post" class="me-2">
                                    <input type="hidden" name="groupId" value="@Model.Id" />
                                    <input type="hidden" name="userId" value="@request.UserId" />
                                    <button type="submit" class="btn btn-sm btn-success">Approve</button>
                                </form>
                                <form asp-action="DeclineUser" asp-controller="Groups" method="post">
                                    <input type="hidden" name="groupId" value="@Model.Id" />
                                    <input type="hidden" name="userId" value="@request.UserId" />
                                    <button type="submit" class="btn btn-sm btn-danger">Decline</button>
                                </form>
                            </div>
                        </li>
                    }
                </ul>
            </div>
        </div>
    }
</div>
